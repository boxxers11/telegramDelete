הנה מפרט מפורט ומדויק עבור Codex לפיתוח, כך שכל פיצ’ר יוטמע בצורה נקייה, אופטימלית, לא שוברת, ומשתלב היטב במערכת. המפרט כולל התנהגות UI/UX, חוזי API, לוגיקה בצד-לקוח/שרת, סטטוס בזמן אמת, אופטימיזציות, בדיקות וקבלות.

עקרונות בסיס
	•	בלי שבירת התנהגות קיימת: כל שינוי מאחורי דגל פיצ’ר (feature flag) עם ברירת־מחדל כבוי בסביבות PROD, והדרגתי.
	•	פעולות הרסניות (מחיקות) יהיו אידמפוטנטיות: קריאה כפולה לא תגרום לשגיאה, מחיקה חוזרת תחזיר סטטוס “כבר נמחק”.
	•	עדכוני UI בזמן אמת דרך Pub/Sub/WebSocket (או SSE) עם fallback לפולינג אקספוננציאלי.
	•	איגוד פעולות (batching) כדי לצמצם עומסים: מחיקות/בדיקות יתבצעו באצוות.
	•	מדדי ניטור: לוגים, מטריקות, וטרייסים עבור כל פעולה (Scan, Fetch, Delete, Verify).

שמות מסכים/אזורי מערכת רלוונטיים
	•	חלון “סריקת הודעות” (רשימת קבוצות עם ממצאים).
	•	אזור “סטטיסטיקות כלליות”.
	•	מודל “כל ההודעות שנמצאו” (חדש).

1) תקיעת טעינת הודעות ב”צפה בהודעות” אחרי סריקה

מטרה: לפתור מצב שבו בלחיצה על “צפה בהודעות” בקבוצה עם ממצאים, מוצג “טוען הודעות” ללא סיום.

התנהגות UI/UX
	•	בלחיצה על “צפה בהודעות” עבור קבוצה:
	•	מצב טעינה עם ספינר ומיקרו-טקסט: “טוען הודעות…”.
	•	טיימאאוט לקליינט: 20 שניות. אם עבר, הצג שגיאה רכה עם CTA לנסות שוב.
	•	ריטריי אוטומטי פעם אחת ברקע (ג’יטר 300–800ms) לפני הצגת השגיאה.
	•	במקרה של ריקון תוצאות (אין הודעות למרות מונה>0) הצג: “לא נמצאו הודעות להצגה. נסה לרענן סריקה.”
	•	Pagination/Infinite scroll: טעינת הודעות באצוות (ברירת־מחדל 50), עם “טוען עוד” בתחתית.

API
	•	GET /api/groups/{groupId}/found-messages?cursor=<token>&limit=50
	•	200: { items: Message[], nextCursor?: string }
	•	204: אין פריטים
	•	504/502: להציג הודעת רשת עם אפשרות רענון
	•	Message: { id, groupId, createdAt, foundAt, text, sender, link?, canDelete }

לוגיקה/אופטימיזציה
	•	Cache קצר־טווח (client-side, 60s) למעבר הלוך־חזור בין קבוצות.
	•	ביטול בקשות תלויות (AbortController) בעת מעבר קבוצה כדי למנוע “רייס”.
	•	מעקב מטריקות: זמן ממוצע לטעינת “צפה בהודעות”, אחוז Timeouts, אחוז שגיאות שרת.

Definition of Done
	•	אין תקיעות “טוען הודעות” מעל 20 שניות בלי שגיאה ידידותית.
	•	רייטריי חד־פעמי עובד, ביטול תקין בעת ניווט.
	•	ניטור מציג ירידה ב-Timeouts מתחת ל-1%.

בדיקות
	•	רשת איטית/מנותקת, קבוצה עם 0/1000 הודעות, דפדוף מהיר בין קבוצות, חזרה למסך.

2) “מחק הכל” ברמת קבוצה + וידוא מחיקה ועדכון סטטוס/אייקון

מטרה: לאחר לחיצה על “מחק הכל” בקבוצה, לבצע מחיקה בשרת, לוודא הצלחה, ולהציג סטטוס ועדכון UI.

התנהגות UI/UX
	•	בלחיצה על “מחק הכל” בקבוצה:
	•	הצג דיאלוג אישור: “למחוק את כל ההודעות שנמצאו בקבוצה זו?”
	•	לאחר אישור: מצב “מוחק…” ברקע, עם פס התקדמות.
	•	עם סיום אימות מחיקה: הצג טוסט “הודעות נמחקו”.
	•	ברשימת השורות של ההודעות בקבוצה: האייקון בתחילת כל שורה מתעדכן לאפור.
	•	אם חלק נכשל:
	•	טוסט אזהרה מסכם: “חלק מההודעות לא נמחקו (X מתוך Y).”
	•	אפשרות “פרטי כשל” לפתיחת רשימת IDs/סיבות.

API
	•	POST /api/groups/{groupId}/found-messages:delete
	•	body: { mode: "all" | "ids", ids?: string[] }
	•	202: { jobId } — מחיקה אסינכרונית
	•	GET /api/jobs/{jobId}/status
	•	200: { state: "running"|"completed"|"failed"|"partial", deletedCount, failed: {id, reason}[] }

לוגיקה/אופטימיזציה
	•	Batch size שרת מומלץ: 100–500 הודעות לאצווה.
	•	איגוד בקשות מחיקה לקבוצה אחת לכל Job.
	•	אימות מחיקה: לאחר completed, בצע בדיקת נוכחות (HEAD /api/messages/{id} או endpoint ייעודי) באצוות.
	•	עדכון UI באירועים דרך WebSocket: messageDeleted/deleteProgress.

Definition of Do ne
	•	הודעות שנמחקו אינן מופיעות עוד ב”צפה בהודעות” ובמודל המרכזי.
	•	אייקון בשורות ההודעות הופך לאפור.
	•	סטטוס מוצג באופן עקבי.

בדיקות
	•	קבוצה קטנה/גדולה, כשלי הרשאות, ניסיונות כפולים (אידמפוטנטי).

3) כפתור עליון: “מחיקת כל ההודעות מהקבוצות” + העלמת קבוצות שנוקו

מטרה: כפתור גורף שמוחק את כל ההודעות שנמצאו בכל הקבוצות בכל הסריקות האחרונות, מסכם כמה נמחק, ומסיר מהרשימה קבוצות שנוקו ואומת עבורן.

התנהגות UI/UX
	•	ליד הכותרת “קבוצות עם הודעות שנסרקו” הוסף כפתור ראשי: “מחיקת כל ההודעות מהקבוצות”.
	•	לחיצה:
	•	דיאלוג אישור: “למחוק את כל ההודעות שנמצאו בכל הקבוצות?”
	•	התקדמות כוללת: מונה כולל וקצב (לדוגמה: “532/1,240 נמחקו…”).
	•	בזמן אמת: טבלת התקדמות מוקטנת לפי קבוצה (שם קבוצה, נמחקו/סה״כ, סטטוס).
	•	בסיום: טוסט מסכם “נמחקו X הודעות”, כפתור “הצג פירוט כשלים” אם יש.
	•	הסתר מה־List את הקבוצות שעבורן הושלם וידוא מחיקה מלא.
	•	Edge cases:
	•	אם ריק: הצג “אין מה למחוק” ללא ביצוע.

API
	•	POST /api/found-messages:deleteAll
	•	202: { jobId }
	•	GET /api/jobs/{jobId}/status — כולל התקדמות לפי groupId:
	•	{ state, totals: {overall:{deleted,total}, byGroup:[{groupId, deleted, total, state}]}, failed: [...] }

לוגיקה/אופטימיזציה
	•	שרת: חלוקה לאצוות לפי קבוצה, הרצת Workers במקביל עם קצב מוגבל (Rate Limit).
	•	קליינט: מיזוג אירועי התקדמות (throttle 250ms) למניעת רינדורים עודפים.
	•	הסתרת קבוצות: רק לאחר state=completed ו-deleted===total עבור הקבוצה.

Definition of Done
	•	הכפתור מבצע מחיקה גורפת עם משוב בזמן אמת.
	•	קבוצות “נקיות” נעלמות מהרשימה ללא הבהובים/קפיצות חריגות.

בדיקות
	•	הרבה קבוצות קטנות/מעט קבוצות גדולות, הפסקת רשת באמצע, ריצות כפולות.

4) שינוי טקסט כפתור: הסרת המילה “סריקת” מכפתור “סריקת הודעות אחרונות”

מטרה: לשנות את הטקסט בלבד, ללא שבירת הקוד המחובר.

התנהגות UI/UX
	•	הטקסט בכפתור משתנה ל”הודעות אחרונות”.
	•	Tooltip/aria-label נשמרים זהים למשמעות הקודמת.
	•	בדוק שכל בדיקות E2E תלויות-טקסט מעודכנות.

Implementation
	•	קבוע טקסטואלי אחד במקור (i18n key) כדי להימנע מפיזור.
	•	בדיקות Snapshot מעודכנות.

Definition of Done
	•	הכפתור מוצג “הודעות אחרונות” בכל לוקל.
	•	ללא שבירת ניווט/אקשנים.

5) אזור “סטטיסטיקות כלליות”: מודל “כל ההודעות שנמצאו”

מטרה: בלחיצה על “x הודעות נמצאו” להציג מודל מרכזי עם כל ההודעות שעדיין לא נמחקו מכל הסריקות האחרונות.

התנהגות UI/UX
	•	לחיצה על הערך “x הודעות נמצאו” פותחת מודל בגודל גדול.
	•	כותרת: “כל ההודעות שנמצאו”.
	•	טבלת נתונים עם מיון בכל כותרת עמודה:
	•	שעה (פורמט שעה מדויקת של ההודעה)
	•	ההודעה (טקסט מקוצר עם אפשרות הרחבה/Tooltip)
	•	קבוצה (שם קבוצה; לחיצה פותחת את הקבוצה בחלון “סריקת הודעות”)
	•	תאריך (תאריך ההודעה או התגלות הממצא, לפי החלטה אחידה; מומלץ תאריך ההודעה, ושדה “נמצאה בתאריך” ב־tooltip)
	•	חיפוש מעל הטבלה (טקסט חופשי) וסינון לפי קבוצה.
	•	Paging: 100 פריטים לדף, עם infinite scroll או pagination.
	•	מצב טעינה, מצב “אין נתונים”, ומצב שגיאה.

API
	•	GET /api/found-messages?status=notDeleted&query=&groupId=&sort=createdAt:desc&cursor=&limit=100
	•	200: { items: Message[], nextCursor? }
	•	Message: { id, groupId, groupName, text, createdAt, foundAt, link?, canDelete }

לוגיקה/אופטימיזציה
	•	סגירה ושחזור מצב: עם חזרה למודל, שמור פרמטרי סינון/מיון אחרונים ב־URL hash או localStorage.
	•	הפחתת העמסה: שליפת שדות מינימליים, טעינת Tooltips/הרחבות on-demand.

Definition of Done
	•	המודל מציג את כל ההודעות שלא נמחקו, עם מיון עובד בכל עמודה.
	•	ניווט לקבוצה מתוך שם הקבוצה עובד.

בדיקות
	•	מיון לפי כל עמודה, חיפוש, סינון, דפדוף גדול מאוד, רשת איטית.

6) בראש המודל: כפתור “מחיקת כל ההודעות” עם סטטוס בזמן אמת

מטרה: לאפשר מחיקה גורפת מכל הקבוצות ישירות מתוך המודל, עם דיווח סטטוס בזמן אמת לכל הודעה.

התנהגות UI/UX
	•	כפתור ראשי בראש המודל: “מחיקת כל ההודעות”.
	•	לאחר לחיצה:
	•	דיאלוג אישור: “למחוק את כל ההודעות שנמצאו בכל הקבוצות?”
	•	בזמן הריצה: פס התקדמות כללי + רשימת פריטים עם סטטוס פר־הודעה:
	•	“ממתין”, “בתהליך”, “נמחק”, “נכשל”.
	•	הצג סטטוס מתעדכן inline בשורה (ללא רענון מלא של הטבלה).
	•	אפשרות “הסתר פריטים שנמחקו” כדי לצמצם רעש בזמן הריצה.
	•	בסיום: טוסט מסכם עם ספירה כוללת ומספר כשלים. כפתור “ייצוא כשלים” (CSV) עם id, group, reason.

API
	•	POST /api/found-messages:deleteAll — אותו Job מרכזי כמו סעיף 3.
	•	אירועי זמן אמת:
	•	deleteProgress ברמת הודעה: { id, state, reason? }
	•	deleteSummary בסיום: { deletedCount, failedCount }

לוגיקה/אופטימיזציה
	•	אם יש הרבה פריטים (10k+), אל תרנדר את כולם בבת אחת:
	•	וירטואליזציית רשימות.
	•	עדכוני סטטוס בקבוצות (batch state updates) כל 200ms.
	•	אם סוקט נופל: fallback לפולינג /api/jobs/{jobId}/status?level=item כל 1.5–3 שניות.

Definition of Done
	•	סטטוס פר־פריט מתעדכן בזמן אמת.
	•	ייצוא כשלים עובד.
	•	המודל נשאר אינטראקטיבי (לא קופא) גם בעומסים.

בדיקות
	•	עשרות אלפים פריטים (בדיקת וירטואליזציה), ניתוק סוקט, כשלי הרשאות/Rate limit.

נגישות ושימושיות
	•	קיצורי מקשים: Esc לסגירת מודל, Enter לאישור בדיאלוג, Tab-order תקין.
	•	ARIA roles עבור מודל, טבלה, כפתורי פעולה, Live regions לסטטוסים מתעדכנים.
	•	טקסטים ברורים, ללא תלות בצבע בלבד (אייקון אפור + טקסט סטטוס).

טלמטריה וניטור
	•	אירועים: view_found_messages, delete_group_all, delete_all_global, modal_open_all_found, modal_delete_all.
	•	מדדים: זמן ריצה ממוצע למחיקה, % הצלחה, % כשלים לפי סיבה (הרשאות/Rate limit/רשת), זמן טעינת “צפה בהודעות”.

תלויות ותצורה
	•	דגלים:
	•	ff_foundMessagesGlobalDelete
	•	ff_foundMessagesModal
	•	הגדרות שרת:
	•	DELETE_BATCH_SIZE ברירת־מחדל 200
	•	DELETE_CONCURRENCY ברירת־מחדל 4
	•	JOB_STATUS_RETENTION_MINUTES ברירת־מחדל 30

אבטחה והרשאות
	•	כל פעולת מחיקה מאומתת ע”י טוקן משתמש והרשאה מתאימה לקבוצות.
	•	רישום אודיט: מי מחק, מתי, כמה, מאילו קבוצות, מזהי הודעות (מושחרים חלקית אם צריך).

בדיקות אוטומטיות
	•	יחידה: מיפוי סטטוסים, ממייני טבלאות, ניהול Cursor, Idempotency.
	•	אינטגרציה: זרימות מחיקה/וידוא/הסתרת קבוצות.
	•	E2E: תרחישים מלאים עם נתונים גדולים, פלאקי רשת, תצורת דגלים.

שינויים טקסטואליים/לוקליזציה
	•	שינוי הכפתור בסעיף 4 דרך i18n key אחד.
	•	טקסטים לכל דיאלוגים/טוסטים בעברית, תמיכה בלוקליזציה עתידית.

הערות יישום קצרות
	•	ודאו שהמידע במודלים וברשימות נשלף lazy, עם ביטול בקשות קודמות בעת סגירה/ניווט.
	•	ודאו שמחק גורף (סעיפים 3 ו-6) משתמש באותו מנגנון Job כדי לפשט שרשרת אחריות.
	•	ודאו שהסתרת קבוצות אחרי מחיקה מלאה מתבצעת רק אחרי אימות שרתי, לא רק עדכון קליינט.

אם יש הבדלים ב־API הקיים מול החוזים המוצעים, אמליץ לבצע שכבת התאמה (Adapter) בצד השרת או הקליינט כדי לא לשבור לוגיקה קיימת, וליישר שמות/פרמטרים באופן עקבי.
